<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èªéŸ³æ†‚é¬±æª¢æ¸¬ç³»çµ±ï¼ˆPHQ-8 å›æ­¸æ¨¡å‹ï¼‰</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #0e0e0e;
      color: #ffffff;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      background-image: radial-gradient(circle at top left, #1e1e1e, #000);
    }

    h1 { text-align: center; color: #ffffff; margin-bottom: 20px; font-size: 28px; letter-spacing: 2px; }
    .section { background: rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 30px; width: 90%; max-width: 750px; box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
    hr { margin: 30px 0; border: none; border-top: 1px solid rgba(255, 255, 255, 0.2); }
    h2 { color: #ffffff; text-align: center; margin-bottom: 10px; }
    p { text-align: center; color: #cccccc; font-size: 14px; }

    .file-section, .record-section { display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .file-row { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }

    input[type="file"] { color: #ccc; background: transparent; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 5px; cursor: pointer; }
    button { padding: 8px 14px; border: none; background-color: #3498db; color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
    button:hover { background-color: #2980b9; transform: scale(1.03); }
    button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    audio { margin-top: 10px; width: 100%; border-radius: 8px; }

    .result-container { display: flex; justify-content: center; margin-top: 20px; flex-wrap: wrap; gap: 10px; }
    .result-box { flex: 1; min-width: 250px; background-color: rgba(255,255,255,0.06); border-radius: 12px; padding: 15px; text-align: center; transition: background 0.3s; }
    .result-box:hover { background-color: rgba(255,255,255,0.12); }
    .result-title { font-weight: bold; color: #66b3ff; margin-bottom: 6px; letter-spacing: 1px; }
    .result-text { font-size: 20px; font-weight: bold; color: #ffffff; min-height: 28px; }

    .loading-overlay { position: fixed; left: 0; top: 0; right: 0; bottom: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999; }
    .loading-card { background: rgba(255,255,255,0.06); border-radius: 12px; padding: 18px 24px; display: flex; align-items: center; gap: 12px; color: #fff; box-shadow: 0 8px 30px rgba(0,0,0,0.6); backdrop-filter: blur(6px); }
    .spinner { width: 28px; height: 28px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.15); border-top-color: #66b3ff; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

	#adviceSection {
	  margin-top: 30px;
	}
	#adviceBox {
	  background-color: rgba(255,255,255,0.06);
	  border-radius: 12px;
	  padding: 20px;
	  text-align: center;
	  transition: background 0.3s;
	}
	#adviceBox:hover {
	  background-color: rgba(255,255,255,0.12);
	}
	#adviceText {
	  font-size: 18px;
	  font-weight: normal;
	  color: #ffffff;
	  min-height: 50px;
	}
  </style>
</head>
<body>
  <h1>èªéŸ³æ†‚é¬±æª¢æ¸¬ç³»çµ±ï¼ˆå›æ­¸æ¨¡å‹ï¼‰</h1>

  <div class="section" id="mainSection">
    <h2>ä½¿ç”¨é å…ˆéŒ„è£½çš„éŸ³è¨Š</h2>
    <div class="file-section">
      <div class="file-row">
        <input type="file" id="audioFile" accept="audio/*">
        <span id="fileName">æœªé¸æ“‡æª”æ¡ˆ</span>
        <button id="uploadFileBtn">ä¸Šå‚³ä¸¦é æ¸¬</button>
      </div>
      <audio id="previewAudio" controls></audio>
    </div>

    <hr />

    <h2>ç«‹åˆ»éŒ„éŸ³æª¢æ¸¬</h2>
    <p>èªªèªªä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Œæˆ–ä½ ç¾åœ¨çš„æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼š</p>
    <div class="record-section">
      <div>
        <button id="startRecord">é–‹å§‹éŒ„éŸ³</button>
        <button id="stopRecord" disabled>åœæ­¢éŒ„éŸ³</button>
        <button id="uploadRecord" disabled>ä¸Šå‚³ä¸¦é æ¸¬</button>
      </div>
      <audio id="recordedAudio" controls></audio>
    </div>

    <div class="result-container">
      <div class="result-box">
        <div class="result-title">å›æ­¸æ¨¡å‹çµæœ</div>
        <div id="regressionResult" class="result-text">å°šç„¡çµæœ</div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
    <div class="loading-card">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadingText">â³ é æ¸¬ä¸­â€¦</div>
    </div>
  </div>

  <div class="section" id="adviceSection">
    <h2>æ ¹æ“šçµæœåˆ†æ®µçµ¦äºˆç”Ÿæ´»å»ºè­°</h2>
    <div class="result-box" id="adviceBox">
      <div class="result-title">ç”Ÿæ´»å»ºè­°</div>
      <div id="adviceText" class="result-text">å°šç„¡çµæœ</div>
    </div>
  </div>

  <script>
  const backendUrl = "https://depressionmodel-ai.onrender.com/predict";

  const fileInput = document.getElementById("audioFile");
  const fileName = document.getElementById("fileName");
  const previewAudio = document.getElementById("previewAudio");
  const uploadFileBtn = document.getElementById("uploadFileBtn");
  const startBtn = document.getElementById("startRecord");
  const stopBtn = document.getElementById("stopRecord");
  const uploadRecordBtn = document.getElementById("uploadRecord");
  const recordedAudio = document.getElementById("recordedAudio");
  const regressionResult = document.getElementById("regressionResult");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const loadingText = document.getElementById("loadingText");

  let serverAwake = false;
  let mediaRecorder, recordedChunks = [];

  function setLoading(isLoading, message = "â³ é æ¸¬ä¸­â€¦(é ä¼°æ™‚é–“ï¼šä¸‰åˆ†é˜)") {
    if (isLoading) {
      loadingText.textContent = message;
      loadingOverlay.style.display = "flex";
    } else {
      loadingOverlay.style.display = "none";
    }
    uploadFileBtn.disabled = isLoading;
    uploadRecordBtn.disabled = isLoading || !recordedAudio.src;
    fileInput.disabled = isLoading;
    startBtn.disabled = isLoading;
    stopBtn.disabled = isLoading || stopBtn.disabled;
  }

  function getAdvice(stage) {
    switch (stage) {
      case 'è¼•åº¦æ†‚é¬±':
        return "æœ‰æ™‚å€™ç”Ÿæ´»ä¸­ç¸½æ˜¯æœƒæœ‰ä¸€é»é»çš„ä¸æ„‰å¿«ï¼Œä¸éå°ä½ å¥½åƒæ²’æœ‰é€ æˆå¤ªå¤§çš„å½±éŸ¿ã€‚è©¦è‘—è®“è‡ªå·±æ”¾é¬†ä¸€ä¸‹ï¼Œè½‰æ›å¿ƒæƒ…ï¼Œå¤šçœ‹çœ‹å‘¨é­é‚£äº›è®“ä½ å¾®ç¬‘çš„å°äº‹å§ï¼";
      case 'ä¸­åº¦æ†‚é¬±':
        return "ä½ å¯èƒ½æ„Ÿè¦ºç”Ÿæ´»è®“ä½ æœ‰äº›å£“åŠ›æˆ–æŒ«æŠ˜ï¼Œé€™æ˜¯å¯ä»¥è¢«ç†è§£çš„ã€‚çµ¦è‡ªå·±ä¸€é»å–˜æ¯çš„æ™‚é–“ï¼Œæ•£æ•£æ­¥ã€é–±è®€æˆ–èˆ‡ä¿¡ä»»çš„äººèŠèŠï¼Œè®“å…§å¿ƒé€æ¼¸å›åˆ°å¹³è¡¡ã€‚";
	  case 'ä¸­é‡åº¦æ†‚é¬±':
        return "ä½ å¯èƒ½å·²ç¶“æ„Ÿå—åˆ°å¿ƒæƒ…ä½è½å½±éŸ¿äº†ç”Ÿæ´»ç¯€å¥ã€‚è©¦è‘—æŠŠç„¦é»æ”¾åœ¨èƒ½å¸¶ä¾†ä¸€é»å¿«æ¨‚çš„äº‹ä¸Šï¼Œä¹Ÿè¨±æ˜¯ä¸€é¦–æ­Œã€ä¸€æ®µå°è©±ã€ä¸€æ¯æº«èŒ¶ã€‚ä½ å€¼å¾—è¢«æº«æŸ”åœ°å°å¾…ã€‚";
      case 'é‡åº¦æ†‚é¬±':
        return "çœ‹èµ·ä¾†ç”Ÿæ´»çš„å£“åŠ›å·²ç¶“è®“ä½ æ„Ÿåˆ°é›£ä»¥æ‰¿å—ã€‚è«‹ä¸è¦ç¨è‡ªé¢å°ï¼Œèˆ‡ä¿¡ä»»çš„äººè«‡è«‡ï¼Œæˆ–å°‹æ±‚å°ˆæ¥­å¿ƒç†å¸«çš„å”åŠ©ã€‚ä½ ä¸¦ä¸å­¤å–®ï¼Œå¹«åŠ©å°±åœ¨ä½ èº«é‚Šã€‚";
      default:
        return "å°šç„¡çµæœï¼Œæš«æ™‚ç„¡æ³•æä¾›å»ºè­°ã€‚è«‹å˜—è©¦ä¸Šå‚³æˆ–éŒ„è£½éŸ³è¨Šé€²è¡Œåˆ†æã€‚";
    }
  }

  function showPredictingState() {
    regressionResult.textContent = "â³ é æ¸¬ä¸­â€¦(ä¼ºæœå™¨å¯èƒ½æ­£åœ¨å•Ÿå‹•ï¼Œè«‹è€å¿ƒç­‰å¾…)";
  }

  function displayResults(data) {
    if (!data) {
      regressionResult.textContent = "âš ï¸ ç„¡å›å‚³è³‡æ–™";
      return;
    }
    regressionResult.textContent = data.regression_stage;
    document.getElementById("adviceText").textContent = getAdvice(data.regression_stage);
  }

  async function fetchWithTimeout(resource, options = {}) {
    const { timeout = 300000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    try {
      const resp = await fetch(resource, { ...options, signal: controller.signal });
      clearTimeout(id);
      return resp;
    } catch (err) {
      clearTimeout(id);
      throw err;
    }
  }

  async function wakeServer() {
    try {
      setLoading(true, "â³ é¦–æ¬¡å–šé†’ä¼ºæœå™¨ä¸­ï¼Œå¯èƒ½éœ€è¦ 1~2 åˆ†é˜...");
      await fetchWithTimeout(backendUrl, { method: "GET" });
      serverAwake = true;
    } catch (err) {
      console.warn("ä¼ºæœå™¨å–šé†’å¤±æ•—:", err.message);
    } finally {
      setLoading(false);
    }
  }

  async function uploadAudio(file) {
    if (!serverAwake) await wakeServer();
    const formData = new FormData();
    formData.append("file", file);
    setLoading(true, "â³ éŸ³è¨Šä¸Šå‚³ä¸­ï¼Œè«‹è€å¿ƒç­‰å¾…ï¼ˆå¯èƒ½ç´„ä¸‰åˆ†é˜ï¼‰...");
    showPredictingState();
    try {
      const res = await fetchWithTimeout(backendUrl, { method: "POST", body: formData });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      displayResults(data);
    } catch (err) {
      regressionResult.textContent = "âš ï¸ ä¸Šå‚³æˆ–ç¶²è·¯éŒ¯èª¤ï¼š" + (err.message || "");
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  // æª”æ¡ˆä¸Šå‚³äº‹ä»¶
  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (file) {
      fileName.textContent = file.name;
      previewAudio.src = URL.createObjectURL(file);
    } else {
      fileName.textContent = "æœªé¸æ“‡æª”æ¡ˆ";
      previewAudio.src = "";
    }
  });

  uploadFileBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if (!file) return alert("è«‹å…ˆé¸æ“‡éŸ³è¨Šæª”æ¡ˆï¼");
    uploadAudio(file);
  });

  // éŒ„éŸ³æ§åˆ¶
  startBtn.addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "audio/wav" });
        recordedAudio.src = URL.createObjectURL(blob);
        uploadRecordBtn.disabled = false;
      };
      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      regressionResult.textContent = "ğŸ™ï¸ éŒ„éŸ³ä¸­â€¦";
    } catch (err) {
      alert("ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™æˆ–è£ç½®ä¸æ”¯æ´ã€‚");
      console.error(err);
    }
  });

  stopBtn.addEventListener("click", () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    regressionResult.textContent = "âœ… éŒ„éŸ³å®Œæˆï¼Œå¯ä¸Šå‚³";
  });

  uploadRecordBtn.addEventListener("click", () => {
    if (!recordedChunks.length) return alert("è«‹å…ˆéŒ„éŸ³å†ä¸Šå‚³ã€‚");
    const blob = new Blob(recordedChunks, { type: "audio/wav" });
    uploadAudio(blob);
  });

  setLoading(false);
  </script>
</body>
</html>
